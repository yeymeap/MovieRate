<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MovieRate.ViewModels"
             xmlns:models="using:MovieRate.Models"
             xmlns:controls="using:MovieRate.Controls"
             xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
             x:Class="MovieRate.Views.ListView"
             x:DataType="vm:ListViewModel">

  <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header -->
    <Border Grid.Row="0" Padding="24 16" BorderThickness="0 0 0 1" BorderBrush="#333">
      <Grid RowDefinitions="Auto,Auto">
        
        <!-- Top row: title, search, sort -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto">
          <TextBlock Grid.Column="0"
                     Text="{Binding ListName}"
                     FontSize="22"
                     FontWeight="Bold"
                     VerticalAlignment="Center"/>
          <TextBox Grid.Column="1"
                   Watermark="Search in list..."
                   Text="{Binding SearchQuery}"
                   Width="200"
                   Margin="0 0 16 0"
                   VerticalAlignment="Center"/>
          <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text="Sort by"
                       Opacity="0.5"
                       VerticalAlignment="Center"/>
            <ComboBox ItemsSource="{Binding SortOptions}"
                      SelectedItem="{Binding SortBy}"
                      Width="140"/>
          </StackPanel>
        </Grid>

        <!-- Bottom row: members -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0 12 0 0">
          <TextBlock Text="Members:"
                     Opacity="0.5"
                     VerticalAlignment="Center"
                     FontSize="12"/>
          <ItemsControl ItemsSource="{Binding Members}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel Orientation="Horizontal" Spacing="4"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="models:SupabaseProfile">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <Border Background="#2a2a2a" CornerRadius="4" Padding="6 2">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="★"
                                 FontSize="10"
                                 Foreground="#FFD700"
                                 VerticalAlignment="Center"
                                 IsVisible="{Binding IsOwner}"/>
                      <TextBlock Text="{Binding DisplayName}"
                                 FontSize="12"
                                 VerticalAlignment="Center"/>
                    </StackPanel>
                  </Border>
                  <Button Content="✕"
                          Command="{Binding $parent[UserControl].((vm:ListViewModel)DataContext).RemoveMemberCommand}"
                          CommandParameter="{Binding}"
                          Classes="Flat"
                          Padding="2"
                          FontSize="10"
                          Opacity="0.5"
                          IsVisible="{Binding !IsOwner}"
                          VerticalAlignment="Center"/>
                </StackPanel>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
          <Button Content="Leave list"
                  Command="{Binding LeaveListCommand}"
                  Classes="Flat"
                  FontSize="12"
                  Opacity="0.5"
                  IsVisible="{Binding !IsOwner}"/>
        </StackPanel>

      </Grid>
    </Border>

    <!-- Movies -->
    <ScrollViewer Grid.Row="1" Padding="24">
      <StackPanel Spacing="8">
        <ProgressBar IsIndeterminate="True"
                     IsVisible="{Binding IsLoading}"
                     Height="2"
                     Margin="0 0 0 8"/>

        <Border Background="#3a2a2a"
                CornerRadius="8"
                Padding="12 8"
                IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
          <TextBlock Text="{Binding StatusMessage}"
                     Foreground="#ff6b6b"/>
        </Border>

        <TextBlock Text="No movies yet. Add one!"
                   Opacity="0.4"
                   FontSize="16"
                   HorizontalAlignment="Center"
                   Margin="0 32"
                   IsVisible="{Binding HasNoMovies}"/>

        <ItemsControl ItemsSource="{Binding Movies}">
          <ItemsControl.ItemTemplate>
            <DataTemplate DataType="models:Movie">
              <Border Background="#1e1e1e"
                      CornerRadius="8"
                      Margin="0 4"
                      ClipToBounds="True">
                <Grid ColumnDefinitions="Auto,*,Auto">

                  <!-- Poster -->
                  <Image Grid.Column="0"
                         Width="60"
                         Height="90"
                         Stretch="UniformToFill"
                         asyncImageLoader:ImageLoader.Source="{Binding PosterUrl}"
                         IsVisible="{Binding PosterUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                  <!-- Info -->
                  <Border Grid.Column="1" Padding="12">
                    <StackPanel Spacing="4" VerticalAlignment="Center">
                      <TextBlock Text="{Binding Title}"
                                 FontSize="16"
                                 FontWeight="SemiBold"/>
                      <TextBlock Text="{Binding ReleaseDate, StringFormat='Released: {0}'}"
                                 Opacity="0.5"
                                 FontSize="12"
                                 IsVisible="{Binding ReleaseDate, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                      <TextBlock Text="{Binding Category}"
                                 Opacity="0.5"
                                 FontSize="12"
                                 IsVisible="{Binding Category, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                      <Button Content="{Binding WatchedStatus}"
                              Command="{Binding $parent[UserControl].((vm:ListViewModel)DataContext).ToggleWatchedStatusCommand}"
                              CommandParameter="{Binding}"
                              Classes="Flat"
                              Padding="0"
                              Opacity="0.7"
                              FontSize="12"/>
                      <controls:StarRatingControl Rating="{Binding Rating, Mode=TwoWay}"/>
                      <TextBlock Text="{Binding AddedByEmail, StringFormat='Added by {0}'}"
                                 Opacity="0.4"
                                 FontSize="11"/>
                    </StackPanel>
                  </Border>

                  <!-- Delete -->
                  <Button Grid.Column="2"
                          Content="✕"
                          Command="{Binding $parent[UserControl].((vm:ListViewModel)DataContext).DeleteMovieCommand}"
                          CommandParameter="{Binding}"
                          Classes="Flat"
                          Opacity="0.5"
                          VerticalAlignment="Top"
                          Margin="0 8 8 0"/>
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

      </StackPanel>
    </ScrollViewer>

    <!-- Add Movie Form -->
    <Border Grid.Row="2" Padding="24 16" BorderThickness="0 1 0 0" BorderBrush="#333">
      <StackPanel Spacing="8">

        <!-- Search Results -->
        <Border IsVisible="{Binding ShowSearchResults}"
                Background="#2a2a2a"
                CornerRadius="8"
                MaxHeight="200">
          <StackPanel>
            <ProgressBar IsIndeterminate="True"
                         IsVisible="{Binding IsSearching}"
                         Height="2"/>
            <ScrollViewer MaxHeight="200">
              <ItemsControl ItemsSource="{Binding SearchResults}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="models:TmdbMovie">
                    <Button HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Command="{Binding $parent[UserControl].((vm:ListViewModel)DataContext).SelectTmdbMovieCommand}"
                            CommandParameter="{Binding}"
                            Classes="Flat"
                            Padding="12 8">
                      <StackPanel>
                        <TextBlock Text="{Binding Title}" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding ReleaseDate}" Opacity="0.5" FontSize="11"/>
                      </StackPanel>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </StackPanel>
        </Border>

        <!-- Input Row -->
        <Grid ColumnDefinitions="*,Auto,Auto,Auto">
          <TextBox Grid.Column="0"
                   Watermark="Search for a movie..."
                   Text="{Binding NewMovieTitle}"
                   Margin="0 0 8 0"/>
          <TextBox Grid.Column="1"
                   Watermark="Category (optional)"
                   Text="{Binding NewMovieCategory}"
                   Width="160"
                   Margin="0 0 8 0"/>
          <Button Grid.Column="2"
                  Content="Search"
                  Command="{Binding SearchMoviesCommand}"
                  Margin="0 0 8 0"/>
          <Button Grid.Column="3"
                  Content="Add Manually"
                  Command="{Binding AddMovieCommand}"/>
        </Grid>

      </StackPanel>
    </Border>

  </Grid>

</UserControl>